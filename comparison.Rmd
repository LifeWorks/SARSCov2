---
title: "Comparision of ranks with enrichment analysis"
output: html_notebook
---

Using the enrichment analysis to compare the rankings and metricsf

```{r}
#install.packages("rlist")
library(rlist)
library(ggplot2)
library(latex2exp)

setwd("~/Dropbox/PNNL/Omics/SARS-COV-2/SARSCov2/")
source("GeneSets.R")

# get the background gene set/list
biggerTransGeneSet <- as.character(read.table("biggerTransGenes.txt",  header = FALSE, sep = "")$V1)
bigTransGeneSet <- as.character(read.table("bigTransGenes.txt",  header = FALSE, sep = "")$V1)
bakgrdGeneList <- bigTransGeneSet
lenBakgrd <- length(bakgrdGeneList)
#
# sars1Targets <- as.character(read.table("sars1-targets.txt", header = FALSE, sep = "")$V1)
# sars2Targets <- as.character(read.table("sars1-targets.txt", header = FALSE, sep = "")$V1)
# sarsTargets <- as.character(read.table("sars-targets.txt", header = FALSE, sep = "")$V1)

```

## Functions for calculating the enrichment scores (using p = 0, which is equavalent to Kolomogrov-Smirnov statistics)

```{r}
esFn <- function(x, p = 1) {
  len = length(x)
  miss = ifelse(x!=0, 0, 1)
  #hiti = ((miss * 2 - 1) - miss) / 2
  if (p == 0) {
    xp <- ifelse(x!=0, 1, 0)
  } else {
    xp = abs(x)**p
  }
  sumxp = sum(xp)
  summiss = sum(miss)
  if (sumxp == 0) {
    hitp = rep(0, len)
  } else {
    hitp = cumsum(xp) / sumxp
  }
  if (summiss == 0) {
    missp = rep(0, len)
  } else {
    missp = cumsum(miss) / summiss
  }
  maximum = max(hitp - missp)
  minimum = min(hitp - missp)
  score = ifelse(abs(maximum) > abs(minimum), maximum, minimum)
  return(score)
}

library(MASS)
epFn <- function(x, xnull) {
  fit <- fitdistr(xnull[xnull > 0], densfun="normal")
  pvalue = 1 - pnorm(abs((x - fit$estimate[1]) / (fit$estimate[2])))
  return(pvalue)
}
```


Use the list of gene to do enrichment analysis

```{r}
samplesize = 1000
targetSetNames <- c("sars1", "sars")
centralities <- c("s-closeness", "s-betweenness")
rankMethods <- c("Number of Increases", "Euclidean Distance", "Absolute Rank Change", "Relative Rank Change", "Absolute Change", "Relative Change", "Combined Score")
# rankMethods <- c("Number.of.Increases", "Euclidean.Distance", "Absolute.Rank.Change", "Relative.Rank.Change", "Absolute.Change", "Relative.Change", "Combined.Score")
virusNames <- c("Sars", "Mers", "Iv", "Eb")

dfEnrich <- setNames(data.frame(matrix(ncol = 8, nrow = 0)), c("genecount", "p", "Enrichment score", "p-value", "Rank method", "Virus name", "Target sets","Hypergraph metrics"))
dfi <- 1
```

### analyze the SARS1 targets with all ranks and metrics

```{r}
for (centrality in centralities) {
    for (virusName in virusNames) {
        infile <- sprintf("./no%s-%s_changes.csv", virusName, centrality)
        if (file.exists(infile)) {
            genelist <- read.csv(infile, header = TRUE, row.names = 1)
            colnames(genelist) <- rankMethods
            allGenenames <- rownames(genelist)
            lenAll <- length(allGenenames)
            
            for (rankMethod in rankMethods) {
                rankOri <- as.matrix(genelist[order(-genelist[rankMethod]),][rankMethod])
                rank <- subset(rankOri, is.finite(rankOri))
                genenames <- rownames(rank)
                
                for (targetSetName in targetSetNames) {
                    targetSet <- as.character(read.table(paste0(targetSetName,"-targets.txt"), header = FALSE, sep = "")$V1)
                    enr <- enrichment_by_fishers(genenames, bakgrdGeneList, targetSet)
                    p = enr$fisher$p.value
                    f = enr$foldx
                    mat = enr$mat
                    lenShort <- length(genenames)
                    zscores <- rank
                    zscores[which(!(genenames %in% targetSet))] <- 0
                    es <- esFn(zscores)
                    sampledValues = c()
                    for (k in 1:samplesize) {
                        sampledis = sample(1:lenBakgrd)
                        tempGenenames <- genenames[sampledis[1:lenShort]]
                        tempZscores <- zscores[sampledis[1:lenShort]]
                        tempZscores[which(!(tempGenenames %in% targetSet))] <- 0
                        sampledValues = c(sampledValues, esFn(tempZscores))
                    }
                    ep = (length(which(sampledValues >= es)) + 1) / (samplesize + 1)
                    #ep = epFn(es, sampledValues)
                    # save test result
                    dfEnrich[dfi,] <- c(mat[1,1], p, es, ep, rankMethod, virusName, targetSetName, centrality)
                    dfi <- dfi + 1
                }
            }
        }
    }
}
```


```{r}
for (centrality in centralities) {
    rankMethod <- "individual"
    infile <- sprintf("./bigTrans-%s-%s-ranks.csv", centrality, rankMethod)
    if (file.exists(infile)) {
        genelist <- read.csv(infile, header = TRUE, row.names = 1)
        allGenenames <- rownames(genelist)
        lenAll <- length(allGenenames)
        for (virusName in virusNames) {
            rankOri <- as.matrix(genelist[order(-genelist[virusName]),][virusName])
            rank <- subset(rankOri, is.finite(rankOri))
            genenames <- rownames(rank)
            for (targetSetName in targetSetNames) {
                targetSet <- as.character(read.table(paste0(targetSetName,"-targets.txt"), header = FALSE, sep = "")$V1)
                enr <- enrichment_by_fishers(genenames, bakgrdGeneList, targetSet)
                p = enr$fisher$p.value
                f = enr$foldx
                mat = enr$mat
                lenShort <- length(genenames)
                zscores <- rank
                zscores[which(!(genenames %in% targetSet))] <- 0
                es <- esFn(zscores)
                sampledValues = c()
                for (k in 1:samplesize) {
                    sampledis = sample(1:lenBakgrd)
                    tempGenenames <- genenames[sampledis[1:lenShort]]
                    tempZscores <- zscores[sampledis[1:lenShort]]
                    tempZscores[which(!(tempGenenames %in% targetSet))] <- 0
                    sampledValues = c(sampledValues, esFn(tempZscores))
                }
                ep = (length(which(sampledValues >= es)) + 1) / (samplesize + 1)
                #ep = epFn(es, sampledValues)
                # save test result
                dfEnrich[dfi,] <- c(mat[1,1], p, es, ep, rankMethod, virusName, targetSetName, centrality)
                dfi <- dfi + 1
            }
        }
    }
}

```

```{r}

```

